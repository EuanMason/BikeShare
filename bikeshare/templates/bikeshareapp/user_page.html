<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
      integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
      crossorigin="anonymous"
    />
    <script
      src="{% static "javascript/jquery-3.5.1.min.js"%}"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />


     <style type="text/css">
      #map {
        height: 57%;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <script>
    let map;
    var trip;
    let imgs = "{% static "img/" %}"
    let markersList = []
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 55.860789, lng: -4.250311 },
            zoom: 12,
            mapTypeId: "terrain",
        });
         // Create a <script> tag and set the USGS URL as the source.
        const script = document.createElement("script");
        script.src =
        "https://developers.google.com/maps/documentation/javascript/examples/json/earthquake_GeoJSONP.js";
        document.getElementsByTagName("head")[0].appendChild(script);
        showInitMap();
        $('#ride-bike').hide();
        $('#current-trip').hide()

        // check if the user has enough credit to have a ride
        var user_credit = "{{wallet}}"
        trip = "{{trip}}"
        if(user_credit <= 0) {
          $('#ride-form-main').hide()
        }
        console.log(trip)
        if(trip != None) {
          $('#ride-form-main').hide()
          $('#current-trip').show()
        }
    }

    function showInitMap (results) {
      $("#main-no-bike-available").hide()
      $.ajax({
        type: "GET",
        dataType: "json",
        url: "/locations-of-availabe-bikes/",
        data: {},
        success: function (response) {
            //alert(response.location);
            var arrayData = response.location;
            for (let i = 0; i < arrayData.length; i++) {
                var currentData = arrayData[i];
                var longitudeData = arrayData[i].longitude;
                var latitudeData = arrayData[i].latitude;

                const latLng = new google.maps.LatLng(latitudeData, longitudeData);
                const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: "location_id_: "+(currentData.location_id),
                })

                const contentPopup = 
                '<div id="content">' +
                '<div id="siteNotice">' +
                "</div>" +
                '<h3 id="firstHeading" class="firstHeading">'+currentData.line_1+'</h3>' +
                '<div id="bodyContent">' +
                "<p><b>Postcode:</b> "+currentData.postcode+"</p>" +
                "<p><b>City:</b> "+currentData.city+"</p>" +
                "</div>" +
                "</div>";

                const infoPopup = new google.maps.InfoWindow({
                  content: contentPopup,
                });

                marker.addListener("click", () => {
                  infoPopup.open(map, marker);
                });
            }
        },
      });
     }

     function goToTrip() {
      location.href="/start_rent_bike/"+ trip + "/";
     }

     function showMap(results) {
       var postcode = $( "#postcode" ).val()
       postcode = postcode.replace(' ','')
       if (postcode.length > 0) {
         $.ajax({
          type: "GET",
          dataType: "json",
          url: "/all-bikes-location/"+postcode,
          data: {},
          success: function (response) {
            // hide the text that ask for the postcode at the beginning
            $( "#alertInitPostcode" ).hide();
            // Show the area to select bikes
            $('#ride-bike').show();
            // Clean markers 
            for (let j = 0; j < markersList.length; j++) {
              markersList[j].setMap(null);
            }
            markersList = []

            var loc = response.data.loc
            var bikes = response.data.bikes
            // Create latlong object to center the map
            var myLatLong = new google.maps.LatLng(loc.latitude, loc.longitude);
            window.setTimeout(() => {
              map.panTo(myLatLong);
              map.setZoom(22);
              map.setCenter(myLatLong);
            }, 30);
            
            const image = {
              url: imgs + '/bike.png',
              origin: new google.maps.Point(0, 0),
              scaledSize: new google.maps.Size(60, 60),
            };

            // To show bike icon on maps
            var pi = Math.PI
            var degrees = 180;
            var radious = 0.00001;
            var randomess_l1 = 0
            var randomess_l2 = 360
            
            var stringHtml = '';
            for (let i = 0; i < bikes.length; i++) {
              var currentBike = bikes[i];

              // Map stuff
              var longitudeData = currentBike.location.longitude;
              var latitudeData = currentBike.location.latitude;
              // Random position
              // From: https://gis.stackexchange.com/questions/37615/how-to-place-markers-on-the-outline-of-a-circle-in-google-maps
              // Accesed on: Feb, 11 2021
              var randomness_degrees = Math.floor(Math.random() * (randomess_l2 - randomess_l1) + randomess_l1);
              var longitudeBike = Math.cos(randomness_degrees * pi / 180 ) * radious + longitudeData;
              var latitudeBike = Math.sin(randomness_degrees * pi / 180 ) * radious + latitudeData;

              const latLngBike = new google.maps.LatLng(latitudeBike, longitudeBike);
              const marker = new google.maps.Marker({
                position: latLngBike,
                map: map,
                title: "bike_: "+(currentBike.bike_id),
                icon: image,
                label: {
                  text: "No. "+currentBike.bike_id,
                  color: "#ffffff",
                  fontSize: "20px",
                  fontWeight: "bold"
                },
              })
              markersList.push(marker)

              // Html stuff
              if (i%3 == 0){
                if (i > 0) {
                  stringHtml+='</div>';
                  stringHtml+='<div class="row">';
                }
                else if(i == 0) {
                  stringHtml+='<div class="row">';
                }
              }


              stringHtml+='<div class="col">';
              stringHtml+='	<div class="row">';
              stringHtml+='	  <div class="col grid-img-style">';
              stringHtml+='		<img class="grid-style " src="'+imgs+'/bike.png" alt="bike">';
              stringHtml+='		<h4>Bike '+"No. "+currentBike.bike_id+'</h4>';
              stringHtml+='	  </div>';
              stringHtml+='	</div>';
              stringHtml+='	<div class="row">';
              stringHtml+='	  <div class="col">';
              stringHtml+='		<button';
              stringHtml+='		  class="startbox btn btn-primary grid-style"';
              stringHtml+='		  type="button"';
              stringHtml+='		  onclick="bikeIDStartSubmit('+currentBike.bike_id+')"';
              stringHtml+='		>';
              stringHtml+='		  Start';
              stringHtml+='		</button>';
              stringHtml+='	  </div>';
              stringHtml+='	  <div class="col">';
              stringHtml+='		<!--- Report Button -->';
              stringHtml+='		<button';
              stringHtml+='		  class="btn btn-dark grid-style"';
              stringHtml+='		  onclick="CallModal('+currentBike.bike_id+')"';
              stringHtml+='		>';
              stringHtml+='		  Report A Problem!';
              stringHtml+='		</button>';
              stringHtml+='	  </div>';
              stringHtml+='	</div>';
              stringHtml+='</div>';
            }

            // Show message if there is no bike available in the location
            if(bikes.length == 0) {
              $("#main-no-bike-available").show()
            } 
            else {
              $("#main-no-bike-available").hide()
            }

            // Html stuff p2
            var neededOnGrid = 3 - (bikes.length % 3);
            if((bikes.length % 3) == 0) {
              neededOnGrid = 0
            }
            for(let x = 0; x < neededOnGrid; x++) {
              stringHtml+='<div class="col"></div>';
            }
            stringHtml+='</div>'

            $('#main-container-bikes').html(stringHtml);
          },
        });
       }
     }

     function addMoneyWallet() {
       // TODO: Check if fields look correct :P
       var amount = $("#am").val()
       var xcsrft =  $.cookie("csrftoken") //"bV2JXP0TnIbUX5Mmq0iF4lUfC34ctY5uZwOKGnaeLwFV8I8lP7OPYLBrLTFcHLKT"; // should get this from cookes
       
        $.ajax({
          type: "POST",
          dataType: "json",
          url: "/recalculate-wallet/",
          data: {
            amount: amount
          },
          beforeSend: function (request) {
            request.setRequestHeader("X-CSRFToken", xcsrft);
          },
          success: function(response){
            var data = response.data;
            var credit = data.credit
            if (credit < 0) {
              alert("You have a debt of "+(-1*credit)+". You will need to add enough money to your wallet before riding again")
            }
            else {
              alert("Your current credit is "+credit)
            }
            location.href = "/home"
          }
        });
     }

    </script>

    <title>Bike Sharing</title>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-light navbar-light fixed-top">
      <div class="container">
        <a href="/home" class="navbar-brand">
          <i class="fas fa-biking"></i>
          <span class="text-primary font-weight-bold">Bike</span>
          Sharing</a
        >
        <button
          class="navbar-toggler"
          data-toggle="collapse"
          data-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a href="/home" class="nav-link">Home</a>
            </li>
            <li class="nav-item">
              <a href="/logout" class="nav-link">Log out</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div id="map"></div>

    <section id="main-page">
      <div class="container">
        <div class="bg-light" style="text-align: center; padding: 0.5rem 0 0.1rem 0;">
          <h3 class="m-heading text-primary">Your wallet has: £{{wallet}}</h3>
        </div>
        <div class="start-form bg-light p-3" id="ride-form-main">
          <h2 class="m-heading">Let's start!</h2>
          <h3 class="m-heading text-danger" id="alertInitPostcode">Enter the postcode of your current location below</h3>
          <div>
            <div class="form-group">
              <label for="postcode">Post Code: </label>
              <input
                class="form-control"
                placeholder="Enter postcode"
                type="text"
                id="postcode"
                class="box"
                required
              />
            </div>
            <div class="form-group">
              <button
                class="submitbox btn btn-primary"
                onclick="showMap()"
              >
                Show on map
              </button>
              <div id="selectBike" class="form-group"></div>
            </div>

            <div id="ride-bike">
              <!--<div class="form-group">
                <label for="bikeID">Bike ID: </label>
                <input
                  class="form-control"
                  placeholder="Enter bike ID"
                  type="text"
                  id="bikeid"
                  class="box"
                  required
                />
              </div> -->
              <div class="form-group container" id="main-container-bikes">
                
              </div>
              <div class="form-group container" id="main-no-bike-available">
                <h3 class="m-heading text-info">No Bikes Available at this Spot at the moment... Sorry about that</h3>
              </div>
            </div>

            <!--- Report Window --->
            <div class="modal fade bd-report-modal-sm" tabindex="-1" role="dialog"  id="ReportModal">
              <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title">Report A Problem!</h5>
                      </div>
                      <div class="modal-body">                            
                          <p><b id="bike-report-text">Would you like to report a problem with this bike?</b></p>
                          <div class="form-group">
                            <label for="report-problem">What's the problem?</label>
                            <textarea class="form-control" id="report-problem" rows="3"></textarea>
                          </div>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-primary btn-block"       
                          id="ConfirmReport" 
                          onclick="bikeIDErrorSubmit()">
                          Confirm
                          </button>
                          <button type="button" class="btn btn-secondary btn-block" 
                          data-dismiss="modal">
                          Close
                          </button>
                      </div>
                  </div>
              </div>
            </div>
            
          </div>
        </div>

        <div class="start-form bg-light p-3" id="current-trip">
          <h2 class="m-heading">You are currently on a trip!</h2>
          <div>
            <div class="form-group">
              Click the button below to go to your trip
            </div>
            <div class="form-group">
              <button
                class="submitbox btn btn-primary"
                onclick="goToTrip()"
              >
                Go To My Trip
              </button>
            </div>
          </div>
        </div>

        <div class="start-form bg-light p-3">
          <h2 class="m-heading">Add money to your wallet!</h2>
          <div>
            <div class="form-group">
              <label for="ccn">Credit Card Number: </label>
              <input
                class="form-control"
                placeholder="Credit Card Number"
                type="number"
                id="ccn"
                class="box"
                required
              />

              <label for="ed">Expirency Date: </label>
              <input
                class="form-control"
                placeholder="Expirency Date"
                type="month"
                id="ed"
                class="box"
                min="2021-02"
                min="100000000"
                max="999999999"
                required
              />

              <label for="sn">Security Number: </label>
              <input
                class="form-control"
                placeholder="Security Number"
                type="number"
                id="sn"
                class="box"
                min="100"
                max="999"
                required
              />

              <label for="am">Amount of Money: </label>
              <input
                class="form-control"
                placeholder="Amount of Money"
                type="number"
                id="am"
                class="box"
                min="1"
                max="9999999999"
                required
              />

            </div>
            <div class="form-group">
              <button
                class="submitbox btn btn-primary"
                onclick="addMoneyWallet()"
              >
                Add Money
              </button>
            </div>
          </div>
        </div>

      </div>
    </section>
    <style type="text/css">
		#time p{
			color: #000000;
			font-size: 45px;
			font-weight: bold;
			margin-left:350px;
			margin-bottom:0px;
			overflow: hidden;
		}
	</style>

    
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
      integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
      crossorigin="anonymous"
    ></script>

    <script
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhwTKf3kSrByV-QeOT5hWAXN7CtM2VHFE&callback=initMap"
    ></script>

    <script src="{% static "javascript/app.js" %}"></script>

  </body>
</html>

<!-- AIzaSyAhwTKf3kSrByV-QeOT5hWAXN7CtM2VHFE -->
